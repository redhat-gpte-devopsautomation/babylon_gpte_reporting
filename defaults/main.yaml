---
gpte_reporting:
  version: v0.1.0
  catalog_item: "{{ vars.anarchy_governor.metadata.name |default('unknown') }}"

  # Flag to indicate if errors should be ignored
  ignore_errors: >-
    {{ vars.anarchy_subject.vars.gpte_reporting_ignore_errors
     | default(vars.anarchy_governor.vars.gpte_reporting_ignore_errors)
     | default(false)
    }}

  # Variables from Anarchy Subject
  guid: "{{ vars.anarchy_subject.vars.job_vars.guid }}"
  uuid: "{{ vars.anarchy_subject.vars.job_vars.uuid }}"
  user_email: >-
    {{ vars.anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-requester-email']
     | default(user_name | regex_replace('(.*)-', '\1@'))
    }}
  user_name: >-
    {{ vars.anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-requester-user']
     | default(vars.anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-claim-namespace'] | regex_replace('^user-', ''))
     | default('')
    }}

  # Combine job vars from governor and subject
  job_vars: >-
    {{ vars.anarchy_subject.vars.job_vars
     | combine(vars.anarchy_governor.vars.job_vars)
    }}

  # Variables from combined job_vars
  env_type: "{{ job_vars.env_type | default(None) }}"
  cloud_provider: "{{ job_vars.cloud_provider | default(None) }}"
  cloud_region: "{{ job_vars.aws_region | default(job_vars.osp_cluster) | default(None) }}"

  # Variables from secret via the gpte_db variable
  mysql_user: "{{ gpte_db.mysql_user | default('provision_writer') }}"
  mysql_password: "{{ gpte_db.mysql_password | default('') }}"
  mysql_host: "{{ gpte_db.mysql_host | default('') }}"
  mysql_port: "{{ gpte_db.mysql_port | default(3306) }}"
  mysql_db: "{{ gpte_db.mysql_db | default('lms_transactional') }}"
